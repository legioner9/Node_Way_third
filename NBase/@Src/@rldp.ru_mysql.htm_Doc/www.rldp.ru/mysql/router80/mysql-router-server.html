<html>
<head>
  <META NAME="Author" CONTENT="Alexey V. Pautov">
  <meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
  <title>Глава 5. Применение MySQL Router</title>
</head>

<body>
<script type="text/javascript">
nN = navigator.appName;
function fsearch(str)
{
  if (document.fform.myradio[0].checked) {
     open('../../../yandex.ru/sitesearch@text=' + str + '&site=' +
          document.location.hostname);
  } else {open('../../../yandex.ru/sitesearch@text=' + str);}
}

function MouseUpHandler(e)
{
  if (nN == 'Netscape' || nN == 'Opera') {
     if (document.getSelection()) {
        str = document.getSelection();
        newstr = str.replace(/\n+/g, ' ');
        str = newstr.replace(/\ +/g, ' ');
        if (str.length > 100) {
           var i;
           i = 0;
           str = str.slice(0, 100);
           i = str.lastIndexOf(' ');
           if (i > 0){str = str.slice(0, i);}
        }
        document.fform.strf.value = str;
     }
  } else if(nN == 'Microsoft Internet Explorer') {
    if (document.selection.createRange()) {
       var range = document.selection.createRange();
       var str = range.text;
    }
    if (str) {
       str = str.replace(/\ +/g, " ");
       document.fform.strf.value = str;
    }
  }
  return true;
}
if (window.Event) {document.captureEvents(Event.MOUSEUP);}
document.onmouseup = MouseUpHandler;
</script>

<center><table><tr><td><a href="../../default.htm">
<IMG SRC="../../img/b_book.gif" ALT="RussianLDP" HEIGHT=48 WIDTH=55
ALIGN=ABSCENTER></a></td>

<td><!--Rating@Mail.ru COUNTEr-->
<a target=_top href="../../../top.mail.ru/jump@from=1364238">
<img src="../../../d1.cd.b4.a1.top.list.ru/counter@id=1364238;t=230"
border=0 height=31 width=88 alt="Рейтинг@Mail.ru"/></a>
</td><!--/COUNTER-->

<td><!-- begin of Top100 code -->
<script id="top100Counter" type="text/javascript"
src="../../../cnt.rambler.ru/top100.jcn@1448139"></script>
<noscript><a href="../../../top100.rambler.ru/top100/default.htm">
<img src="../../../cnt.rambler.ru/top100.cnt@1448139" alt="Rambler's Top100"
width="81" height="63" border="0" /></a></noscript>
<!-- end of Top100 code --></td>

<td><!-- HotLog -->
<script type="text/javascript" language="javascript">
hotlog_js="1.0";
hotlog_r=""+Math.random()+"&s=525943&im=127&r="+escape(document.referrer)+
"&pg="+escape(window.location.href);
document.cookie="hotlog=1; path=/"; hotlog_r+="&c="+(document.cookie?"Y":"N");
</script>
<script type="text/javascript" language="javascript1.1">
hotlog_js="1.1";hotlog_r+="&j="+(navigator.javaEnabled()?"Y":"N")
</script>

<script type="text/javascript" language="javascript1.2">
hotlog_js="1.2";
hotlog_r+="&wh="+screen.width+'x'+screen.height+"&px="+
(((navigator.appName.substring(0,3)=="Mic"))?
screen.colorDepth:screen.pixelDepth)</script>

<script type="text/javascript" language="javascript1.3">
hotlog_js="1.3"</script>
<script type="text/javascript" language="javascript">
hotlog_r+="&js="+hotlog_js;
document.write("<a href='../../../click.hotlog.ru/@525943' target='_top'>
<img "+" src='http://hit27.hotlog.ru/cgi-bin/hotlog/count?"+
hotlog_r+"&' border=0 width=88 height=31 alt=HotLog><\/a>")</script>

<noscript>
<a href="../../../click.hotlog.ru/@525943" target="_top">
<img src="../../../hit27.hotlog.ru/cgi-bin/hotlog/count@s=525943&im=127"
border="0" width="88" height="31" alt="HotLog"></a></noscript></td>
<!-- /HotLog -->

<td><!--LiveInternet counter--><script type="text/javascript"><!--
document.write("<a href='../../../www.liveinternet.ru/click' "+
"target=_blank><img src='http://counter.yadro.ru/hit?t52.15;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";"+Math.random()+"' alt='' title='LiveInternet: показано число просмотров и"+
" посетителей за 24 часа' "+"border=0 width=88 height=31><\/a>")//-->
</script></td></tr>
<!--/LiveInternet-->

<tr><td><FONT SIZE=-1><b>WebMoney:&nbsp;</b><br>
WMZ Z294115950220&nbsp;<br>
WMR R409981405661&nbsp;<br>
WME E134003968233&nbsp;</FONT></td>

<td><FONT SIZE=-1><b>Visa&nbsp;</b><br>
4274 3200 2453 6495&nbsp;</FONT></td>
</tr></table></center>
<P><index><table><tr><td>

<h1><a name="mysql-router-server"></a>Глава 5. Применение MySQL Router</h1>
<p>MySQL Router это исполняемый файл, который, как правило, работает
на той же самой машине, где приложение, которое использует его.
В этой главе описываются применение включая доступные параметры, как
запустить приложение, и как использовать журналирование.</p>

<p><a name="mysql-router-server-options"></a>
Есть много вариантов, доступных для управления, выполняя
<a href="mysql-router-configuration.html#mysqlrouter"><span class="command">
<strong>mysqlrouter</strong></span></a>. См. описание
<a href="mysql-router-configuration.html#mysqlrouter"><span class="command">
<strong>mysqlrouter</strong></span></a>.</p>

<h2><a name="mysql-router-server-starting"></a>5.1. Запуск MySQL Router</h2>
<p>MySQL Router требует конфигурационный файл. Хотя роутер ищет
предопределенный список путей по умолчанию для конфигурационного файла,
можно запустить его, передав конфигурационный файл опцией
<a href="mysql-router-configuration.html#option_mysqlrouter_config">
<code class="option">--config</code></a>.</p>

<p>Процесс формирования MySQL Router для автозапуска
подобен шагам, необходимым для сервера MySQL, которые описаны в
<a href="../../../dev.mysql.com/doc/refman/8.0/en/automatic-start.html"
target="_top">Starting and Stopping MySQL Automatically</a>.</p>

<p>Например, используя <span class="bold"><strong>systemd</strong></span>:
<pre>
shell&gt; <strong class="userinput"><code>sudo systemctl start mysqlrouter.service</code></strong>
shell&gt; <strong class="userinput"><code>sudo systemctl enable mysqlrouter.service</code></strong>
</pre>

<h3><a name="mysql-router-server-starting-logs"></a>
Вывод журнала в качестве примера</h3>
<p>Старт MySQL Router производит несколько записей в журнале, например,
соединяясь с кластером InnoDB:
<pre>
shell&gt; <strong class="userinput"><code>mysqlrouter --config=/path/to/file/my_router.conf</code></strong>
^C

shell&gt; <strong class="userinput"><code>less /path/to/log/mysqlrouter.log</code></strong>
2017-04-07 16:30:49 INFO[0x7000022fc000] [routing:devCluster_default_ro] started: listening on 0.0.0.0:6447; read-only
2017-04-07 16:30:49 INFO[0x70000237f000] [routing:devCluster_default_rw] started: listening on 0.0.0.0:6446; read-write
2017-04-07 16:30:49 INFO[0x700002402000] [routing:devCluster_default_x_ro] started: listening on 0.0.0.0:64470; read-only
2017-04-07 16:30:49 INFO[0x700002485000] [routing:devCluster_default_x_rw] started: listening on 0.0.0.0:64460; read-write
2017-04-07 16:30:49 INFO[0x700002279000] Starting Metadata Cache
2017-04-07 16:30:49 INFO[0x700002279000] Connections using ssl_mode 'PREFERRED'
2017-04-07 16:30:49 INFO[0x700002279000] Connected with metadata server running on 127.0.0.1:3310
2017-04-07 16:30:49 INFO[0x700002279000] Changes detected in cluster 'devCluster' after metadata refresh
2017-04-07 16:30:49 INFO[0x700002279000] Metadata for cluster 'devCluster' has 1 replicasets:
2017-04-07 16:30:49 INFO[0x700002279000] 'default' (3 members, single-master)
2017-04-07 16:30:49 INFO[0x700002279000] localhost:3310 / 33100 - role=HA mode=RW
2017-04-07 16:30:49 INFO[0x700002279000] localhost:3320 / 33200 - role=HA mode=RO
2017-04-07 16:30:49 INFO[0x700002279000] localhost:3330 / 33300 - role=HA mode=RO
2017-04-07 16:30:49 INFO[0x700002714000] Connected with metadata server running on 127.0.0.1:3310
</pre>

<p>Регистрация показывает, что MySQL Router слушает на четырех портах,
перечисляет активные стратегии направления по имени, информацию о кластере
InnoDB и прочее.</p>

<p>Например, первая строка перечисляет активные стратегии направления под
именем <code class="literal">routing:devCluster_default_ro</code>, слушающую
порт <code class="literal">6447</code> в режиме
<code class="literal">read-only</code>.
Соответствующая секция в конфигурационном файле MySQL Router:
<pre>
[routing:devCluster_default_ro]
bind_address=0.0.0.0
bind_port=6447
destinations=metadata-cache://devCluster/default?role=SECONDARY
mode=read-only
protocol=classic
</pre>

<p>Посмотрите, как имя, порт и способ были взяты непосредственно из
конфигурационного файла. Таким образом можно быстро определить, какие
стратегии направления активны. Это могло быть особенно полезно, управляя
несколькими экземплярами MySQL Router, или если много
конфигурационных файлов загружается.</p>

<p>В Windows MySQL Router может установить, удалить или начать обслуживание.
По умолчанию сервисное название <span class="emphasis"><em>MySQLRouter</em>
</span>. См. <a href="mysql-router-configuration.html#option_mysqlrouter_service">
<code class="option">--service</code></a> и связанные параметры командной
строки для служб Windows.</p>

<h3><a name="mysql-router-server-starting-scripts"></a>
Примеры скриптов Start и Stop</h3>
<p>Самонастройка MySQL Router с опцией
<a href="mysql-router-configuration.html#option_mysqlrouter_directory">
<code class="option">--directory</code></a> производит скрипты bash для
запуска и остановки MySQL Router, которые выглядят подобными следующему:
<pre>
// *** start.sh *********************** //
#!/bin/bash
basedir=/opt/myrouter
ROUTER_PID=$basedir/mysqlrouter.pid /usr/bin/mysqlrouter -c $basedir/mysqlrouter.conf &amp;
disown %-

// *** stop.sh *********************** //
if [ -f /opt/myrouter/mysqlrouter.pid ]; then
kill -HUP `cat /opt/myrouter/mysqlrouter.pid`
rm -f /opt/myrouter/mysqlrouter.pid
fi
</pre>

<h2><a name="mysql-router-server-logging"></a>
5.2. Использование функции журналирования</h2>
<p>Эта функция может быть удобной для развития и тестирования вашего
приложения и развертывания MySQL Router. Чтобы использовать регистрацию,
включите в конфигурационном файле опцию
<a href="mysql-router-configuration.html#option_mysqlrouter_level">
<code class="option">level</code></a> в секции
<code class="literal">[logger]</code>:
<pre>
[logger]
level = INFO
</pre>

<p>Установите местоположение файла журнала опцией
<a href="mysql-router-configuration.html#option_mysqlrouter_logging_folder">
<code class="option">logging_folder</code></a>, определенной как путь к
каталогу в секции <code class="literal">[DEFAULT]</code> в конфигурационном
файле. Файл журнала называется <code class="filename">mysqlrouter.log</code>:
<pre>
[DEFAULT]
# Logs are sent to /path/to/folder/mysqlrouter.log
logging_folder = /path/to/folder

[logger]
level = DEBUG
</pre>

<p>Установка <code class="option">logging_folder</code>
к пустой строке посылает сообщения на консоль (stdout).</p>
<p>Два общих уровня регистрации <code class="literal">INFO</code> (по
уомлчанию) и <code class="literal">DEBUG</code>:
<ul><li><code class="literal">INFO</code>: включает информационные сообщения,
как показано выше, это режим по умолчанию.</li>

<li><code class="literal">DEBUG</code>: включает сообщения, произведенные в
исходном коде для использования в диагностике. Режим
<code class="literal">DEBUG</code> представляет многословную информацию
относительно внутренних работ. В то время как это может не представлять
интереса для применения, использование режима
<code class="literal">DEBUG</code> может быть полезным, если вы сталкиваетесь
с проблемой, или когда роутер не ведет себя, как вы ожидаете.</li></ul>

<p>Следующий пример показывает то, на что сообщения похожи для уровня
журналирования <code class="literal">DEBUG</code>, сравните сообщения
<code class="literal">INFO</code> и <code class="literal">DEBUG</code>:
<pre>
2017-04-07 18:25:56 INFO[0x700009673000] Connections using ssl_mode 'PREFERRED'
2017-04-07 18:25:56 INFO[0x700009673000] Connected with metadata server running on 127.0.0.1:3310
2017-04-07 18:25:56 DEBUG [0x700009673000] Updating metadata information for cluster 'devCluster'
2017-04-07 18:25:56 DEBUG [0x700009673000] Updating replicaset status from GR for 'default'
2017-04-07 18:25:56 DEBUG [0x700009673000] Replicaset 'default' has 3 members in metadata, 3 in status table
2017-04-07 18:25:56 DEBUG [0x700009673000] End updating replicaset for 'default'
2017-04-07 18:25:56 INFO[0x700009673000] Changes detected in cluster 'devCluster' after metadata refresh
2017-04-07 18:25:56 INFO[0x700009673000] Metadata for cluster 'devCluster' has 1 replicasets:
</pre>

</index></td><td width="20%">
<script type="text/javascript">
    var begun_auto_colors           = new Array();
    var begun_auto_fonts_size       = new Array();
    var begun_auto_pad              =       97517308;     // идентификатор площадки
    var begun_auto_limit            =              5;     // число объявлений выводимых на площадке
    var begun_auto_width            =            250;     // ширина блока объявлений
    begun_auto_colors[0]            =      '#0000CC';     // цвет ссылки объявлений
    begun_auto_colors[1]            =      '#000000';     // цвет текста объявления
    begun_auto_colors[2]            =      '#00CC00';     // цвет домена объявления
    begun_auto_colors[3]            =      '#FFFFFF';     // цвет фона блока объявлений
    begun_auto_fonts_size[0]        =          '9pt';     // р-мер шрифта ссылки объявлений
    begun_auto_fonts_size[1]        =          '9pt';     // р-мер шрифта текста объявления
    begun_auto_fonts_size[2]        =          '8pt';     // р-мер шрифта домена объявления
    begun_auto_fonts_size[3]        =          '8pt';     // р-мер шрифта заглушки
    var begun_block_type            =     'Vertical';     // тип блока
    var begun_rambler_type          =              1;     // цвет блока поиска Рамблер
    begun_koi8 = 1;
</script>
<script src="../../../autocontext.begun.ru/autocontext.js"
type="text/javascript"></script>
</td></tr></table>

<p><table><tr><td>
<form method="get" name="fform" onSubmit="fsearch(strf.value); return false;">
<input type="hidden" name="clid" value="39177">
<b>Поиск</b><table><tr>
<td><input type="text" name="strf" size="15" style="font-size: 9pt" /></td></tr>
<tr><td><font size="-1"><input type="radio" name="myradio" value="0"
checked id="at_site"/>
<label for="at_site">На сайте</label><br>
<input type="radio" name="myradio" value="1" id="at_ya">
<label for="at_ya">В Яндексе</label></font></td></tr>
<tr><td><input type="submit" value="Найти" style="font-size: 9pt"/></td></tr>
</table></form></td>
<td>&nbsp;</td><td><script language="JavaScript"
src="../../../b190.takru.com/in.php@id=199275">
</script></td></tr></table></p>

<p><center><table><tr><td><font size="+1"><B>Найди своих коллег!</B></font><BR>
<script language="javascript"
src="../../../rldp.lovemesweet.ru/banner/db.js.php@rows=01&cols=05&bg=33FF33&sex=0&afrom=18&ato=99&headgif=&sf=1&nwnd=1&pmin=0&cid=RU&tid=0&smu=0&tcl1=000000&tcl2=FF0000">
</script></td>

<td><iframe src="../../../www.linuxcenter.ru/trans/list.phtml@ref=121965&n=5&price=yes"
frameborder="0" vspace="0" hspace="0" width="300" height="350" marginwidth="0"
marginheight="0" scrolling="no"></iframe></td></tr></table></center></p>

<P><FONT SIZE=-1>Вы можете <A HREF="mailto:alexey.v.pautov@mail.ru">
направить письмо</A> администратору этой странички, Алексею Паутову.</FONT>
<A HREF="mailto:alexey.v.pautov@mail.ru"><IMG SRC="img/email.gif"
ALT="mailto:alexey.v.pautov@mail.ru" BORDER=0 valign="center" HEIGHT=35
WIDTH=105 ALIGN=ABSCENTER></A></P>

<script type="text/javascript" src="../../../bin-layer.ru/popup-686-1.js">
</script>

</body>
</html>
